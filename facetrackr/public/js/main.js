function init(){content=document.getElementById("content"),window.addEventListener("focus",start,!1),window.addEventListener("blur",stop,!1),webcam=new Webcam,tracker=new clm.tracker,tracker.init(window.pModel),eyeRect={x:0,y:0,w:0,h:0},originalCanvas=document.getElementById("originalCanvas"),originalContext=originalCanvas.getContext("2d"),trackerCanvas=document.getElementById("trackerCanvas"),trackerContext=trackerCanvas.getContext("2d"),eyeCanvas=document.getElementById("eyeCanvas"),eyeContext=eyeCanvas.getContext("2d"),bwCanvas=document.getElementById("bwCanvas"),bwContext=bwCanvas.getContext("2d"),thCanvas=document.getElementById("thCanvas"),thContext=thCanvas.getContext("2d"),oldCanvas=document.getElementById("oldCanvas"),oldContext=oldCanvas.getContext("2d"),curCanvas=document.getElementById("curCanvas"),curContext=curCanvas.getContext("2d"),cCanvas=document.getElementById("cCanvas"),cContext=cCanvas.getContext("2d"),correlationPercentage=document.getElementById("correlationPercentage"),blinksDetected=document.getElementById("blinksDetected")}function start(t){t.preventDefault(),document.body.className="active",webcam.start(),tracker.start(webcam.domElement),raf=requestAnimationFrame(update),interval=setInterval(correlation,100),blinks=0}function stop(t){t.preventDefault(),document.body.className="",webcam.stop(),tracker.stop(),cancelAnimationFrame(raf),clearInterval(interval),blinks=0}function update(){raf=requestAnimationFrame(update),originalContext.clearRect(0,0,originalContext.canvas.width,originalContext.canvas.height),trackerContext.clearRect(0,0,trackerContext.canvas.width,trackerContext.canvas.height),bwContext.clearRect(0,0,bwContext.canvas.width,bwContext.canvas.height),thContext.clearRect(0,0,thContext.canvas.width,thContext.canvas.height),oldContext.clearRect(0,0,oldContext.canvas.width,oldContext.canvas.height),curContext.clearRect(0,0,curContext.canvas.width,curContext.canvas.height),cContext.clearRect(0,0,cContext.canvas.width,cContext.canvas.height),originalContext.drawImage(webcam.domElement,0,0,originalContext.canvas.width,originalContext.canvas.height),trackerContext.drawImage(webcam.domElement,0,0,trackerContext.canvas.width,trackerContext.canvas.height),tracker.draw(trackerCanvas);var t=tracker.getCurrentPosition();if(t){eyeRect.x=t[23][0],eyeRect.y=t[24][1],eyeRect.w=t[25][0]-t[23][0],eyeRect.h=t[26][1]-t[24][1],eyeContext.drawImage(originalCanvas,eyeRect.x,eyeRect.y,eyeRect.w,eyeRect.h,0,0,eyeContext.canvas.width,eyeContext.canvas.height);var e=CanvasFilters.getPixels(eyeCanvas),a=CanvasFilters.grayscale(e,settings.contrast,settings.brightness);bwContext.putImageData(a,0,0);var e=CanvasFilters.getPixels(eyeCanvas),a=CanvasFilters.grayscale(e,settings.contrast,settings.brightness),n=CanvasFilters.threshold(a,settings.threshold);thContext.putImageData(n,0,0),oldData&&oldContext.putImageData(oldData,0,0),curData&&curContext.putImageData(curData,0,0),cData&&cContext.putImageData(cData,0,0)}}function correlation(){curData&&(oldData=curData),curData=thContext.getImageData(0,0,thContext.canvas.width,thContext.canvas.height),cData=cContext.createImageData(cContext.canvas.width,cContext.canvas.height);var t=0;if(oldData&&curData)for(var e=curData.data.length,a=0;a<e;a+=4)cData.data[a+3]=255,curData.data[a]!==oldData.data[a]&&(cData.data[a]=255,t++);currentCorrelation=t/(cContext.canvas.width*cContext.canvas.height),correlationPercentage.innerHTML=parseFloat(currentCorrelation).toFixed(2)+"%",currentCorrelation>settings.minCorrelation&&blinks++,blinksDetected.innerHTML=blinks+" blinks detected"}var content,webcam,tracker,raf,eyeRect,interval,oldData,curData,cData,currentCorrelation,blinks,originalCanvas,originalContext,trackerCanvas,trackerContext,eyeCanvas,eyeContext,bwCanvas,bwContext,thCanvas,thContext,oldCanvas,oldContext,curCanvas,curContext,cCanvas,cContext,correlationPercentage,blinksDetected,settings={contrast:5,brightness:.5,threshold:80,minCorrelation:.15};init();